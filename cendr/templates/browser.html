{% extends "_layouts/default.html" %}

{% block custom_head %}

<!-- jQuery UI CSS -->
<link rel="stylesheet" type="text/css"
      href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"/>

<!-- Font Awesome CSS -->
<link rel="stylesheet" type="text/css"
      href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"/>

<!-- IGV CSS -->
<link rel="stylesheet" type="text/css" href="//igv.org/web/release/1.0.0-rc1/igv-1.0.0-rc1.css">

<!-- jQuery JS -->
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>


<script type="text/javascript" src="{{ url_for('static', filename = 'js/igv-rc1.js') }}"></script>
{% endblock %}


{% block content %}
<div class="row">
      <div class="col-md-12">
    <div class="well">
    <div class="row">
      <div class="col-md-4">
      <h4>Standard</h4>
      {% for i in ["Genes", "Transcripts"] %}
        <div class="checkbox">
          <label><input type="checkbox" checked class="track-select" value="{{ i }}" />{{ i }}</label>
        </div>
      {% endfor %}
      {% for i in ["phyloP", "phastCons", "Variants"] %}
        <div class="checkbox">
          <label><input type="checkbox" class="track-select" value="{{ i }}" />{{ i }}</label>
        </div>
      {% endfor %}
        <br>
        <h4>Homologus Gene Search</h4>
        <input type="text" class="form-control" id="gene-search" placeholder="e.g. IRF">
      </div>
      <div class="col-md-4">

        <h4>Variant Effects <a href="{{ url_for('help_item', filename = 'Variant-Prediction') }}"><span class="glyphicon glyphicon-question-sign"></span></a></h4>

        <div class="checkbox">
            <label><input type="checkbox" class="track-select" value="LOW" />LOW</label>
        </div>

        <div class="checkbox">
              <label><input type="checkbox" class="track-select" value="MODERATE" />MODERATE</label>
        </div>

        <div class="checkbox">
              <label><input type="checkbox" class="track-select" value="HIGH" />HIGH</label>
        </div>

      </div>

      <div class="col-md-4">

        <h4>Strains</h4>

        <form class="form-inline pull-xs-right">

          <input class="form-control" id="filter" type="text" style="width:100%;  margin-bottom: 5px;" placeholder="e.g. JU360" autocomplete="off">

        </form>

        <table id='browser_strain_list' class="table table-striped table-hover table">
          
          <tbody class="searchable">

            {% for isotype in isotypes %}

              <tr class="isotype-select">

              <td class='isotype-item'><label><input type="checkbox" class="track-select" value="{{ isotype }}" /> {{ isotype }}</label></td>

              </tr>

            {% endfor %}

          </tbody>

        </table>

      </div>

    </div>
     
    </div>


<div id="browser"></div>

<h3>Variants</h3>

<table class="table table-striped table-hover" style="margin-top:10px;" id="variants">

<p><small>Maximum of 1000 variants from the region will be listed.</small></p>
  
<thead>
  <tr>
    <th>CHROM</th>
    <th>POS</th>
    <th>Name</th>
    <th>WormBase ID</th>
    <th>CDS</th>
    <th>Coding Change</th>
    <th>Biotype</th>
    <th>Annotation</th>
    <th>Putative Impact</th>
  </tr>
</thead>

<tbody>
</tbody>

</table>
      
      </div>
  </div>
{% endblock %}

{% block script %}


<script type="text/javascript">

trackset = {"Genes": {
                            name: "Genes",
                            displayMode: "EXPANDED",
                            order: 1,
                            url: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/elegans_gene.WS245.bed",
                            //indexURL: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/elegans_transcripts_WS245.bed.idx",
                            searchable: true,
                            color: "#5c5cd6",
                            height: 30
                     },
            "Transcripts": {
                            name: "Transcripts",
                            url: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/elegans_transcripts_WS245.bed",
                            indexURL: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/elegans_transcripts_WS245.bed.idx",
                            order: 2,
                            color: "#a366ff",
                            displayMode: "SQUISHED",
                            searchable: true
                           },
            "LOW": {
                            name: "LOW",
                            url: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.LOW.bed",
                            indexURL: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.LOW.bed.idx",
                            order: 3,
                            color: "#33cc33",
                            displayMode: "EXPANDED",
                            height: 20
                   },
            "MODERATE": {
                            name: "MODERATE",
                            url: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.MODERATE.bed",
                            indexURL: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.MODERATE.bed.idx",
                            order: 4,
                            color: "#ffc500",
                            displayMode: "EXPANDED",
                            height: 20
                   },
            "HIGH": {
                            name: "HIGH",
                            sourceType: "gcs",
                            url: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.HIGH.bed",
                            indexURL: "https://storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ build }}.HIGH.bed.idx",
                            order: 5,
                            color: "#ff0000",
                            displayMode: "EXPANDED",
                            height: 20
                   },
            "Variants": {
                            name: "Variants",
                            url: "//storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/WI.{{ build }}.filtered.vcf.gz",
                            indexURL: "//storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/WI.{{ build }}.filtered.vcf.gz.tbi",
                            order: Number.MAX_VALUE,
                            displayMode: "SQUISHED",
                            color: "#000000",
                            homvarColor: "#0066ff",
                            homrefColor: "#c2c2d6",
                            visibilityWindow: 20000
                        },
            "phastCons": {
                name: "phastCons",
                url: "//storage.googleapis.com/andersen_dist/genome/elegans.phastcons.bw",
                order: 6,
                displayMode: "SQUISHED",
                color: "#000000",
                visibilityWindow: 20000
            },
            "phyloP": {
                name: "Phylop",
                url: "//storage.googleapis.com/andersen_dist/genome/elegans.phylop.bw",
                order: 6,
                displayMode: "SQUISHED",
                color: "#000000",
                visibilityWindow: 20000
            },

            {% for strain in isotypes %}
            {{ strain }} : {
              name: "{{ strain }}",
              url: "//storage.googleapis.com/andersen_dist/vcf/all/{{ build }}/browser/{{ strain }}.vcf.gz",
              order: 100,
              displayMode: "EXPANDED",
              color: "#ffffff",
              homvarColor: "#0066ff",
              homrefColor: "#c2c2d6",
              visibilityWindow: 20000,
              searchable: false
            },
            {% endfor %}



}

    $(document).ready(function () {
      {% for k,v in putative_impact_items %}
        {% if v in var_eff %}
          $('.track-select[value="{{ v }}"]').prop('checked',true);
        {% endif %}
      {% endfor %}

        var div = $("#browser")[0],
                options = {
                    showNavigation: true,
                    showKaryo: false,
                    reference: {
                      id: "WS245",
                      fastaURL: "//storage.googleapis.com/andersen_dist/genome/c_elegans.PRJNA13758.WS245.genomic.fa",
                      indexURL: "//storage.googleapis.com/andersen_dist/genome/c_elegans.PRJNA13758.WS245.genomic.fa.fai",
                      // cytobandURL: ""
                    },
                    locus: "{{ chrom }}:{{ start }}-{{ end }}",
                    tracks: [
                        {% for i in var_eff %}
                          trackset["{{ i }}"],
                        {% endfor %}
                        trackset["Genes"],
                        trackset["Transcripts"]                    ],
                };
        igv.createBrowser(div, options);

// Detect track changes
$(".track-select").on("change", function() { 
  if ($(this).prop("checked") == true) {
    igv.browser.loadTrack(trackset[$(this).attr("value")]);
  } else {
    remove_track = $(this).attr("value");
    $.each(igv.browser.trackViews, function(k, v) {
      if(v.track.name == remove_track) {
        igv.browser.removeTrack(v.track);
      }
    })
  }
})

var_effect_class = {"LOW": "success",
                    "MODERATE":"warning",
                    "HIGH": "danger"}

function search_orthologs() {
  $('#gene-search').keyup(function() {
    var gene = $(this).val();
    console.log(gene);
    $.ajax({
         url: "/api/homologue/" + gene,
         method: "GET",
         contentType: 'application/xml',
         }).done(function(msg) {
          console.log(msg);
          })
        })
 }

function refresh_variants() {
    region = $(".igvNavigationSearchInput").val()
    chrom = region.split(":")[0]
    start = region.split(":")[1].split("-")[0].replace(/,/g, "");
    end = region.split(":")[1].split("-")[1].replace(/,/g, "");
    possible_tracks = {'LOW':'l', 'MODERATE':'m', 'HIGH':'h'};
    tracks = "";
    for (track in possible_tracks) {
         if ($(".track-select[value="+track+"]").prop("checked") == true){
            tracks += possible_tracks[track];
         }
    }


    $("#variants > tbody").html("");

    var loc = chrom + "/" + start + "/" + end + "/" + tracks;
    // update browser
    window.history.pushState({"pageTitle": document.title + "|" + loc},"", "/data/browser/" + loc);
    $.ajax({
         url:"/api/gt/" + loc,
         method: "GET",
         contentType: 'application/json',
         }).done(function(msg) {
          $.each(msg, function(k, v) {
            if (v["gene_id"] != "") {
              v["gene_id"] = "<a href='http://www.wormbase.org/species/c_elegans/gene/" + v["gene_id"] + "'>" + v["gene_id"] + "</a>";
                }

            items = [v["CHROM"],
                     Number(v["POS"]).toLocaleString('en'),
                     v["locus"],
                     v["gene_id"],
                     v["feature_id"],
                     v["hgvs_p"],
                     v["biotype"],
                     v["annotation"].split("&").join(", "),
                     v["putative_impact"]];
            $("#variants > tbody").append("<tr class='" + var_effect_class[v["putative_impact"]] + "'><td>" + items.join("</td><td>") + "</td></tr>")
          })

          // Enable links
          $( "#variants a" ).on( "click", function() {
              window.location = $(this).attr('href');
          });

        });


}


$("#browser").on("mouseup", function() { 
  setTimeout(refresh_variants, 200); 
})

$("#gene-search").keypress(function(e) {
  console.log(e);
  search_orthologues();
})

$(".checkbox").on("click", function() { 
  setTimeout(refresh_variants, 200); 
})

$(".igvNavigationSearchInput").on("input paste", function() {
  refresh_variants();
});

$(".track-select").on("change", function() {
  refresh_variants();
});

$(".igvNavigationSearchInput").keypress(function(e) {
    if(e.which == 13) {
      setTimeout(refresh_variants, 200); 
    }
});



// Initial load
setTimeout(refresh_variants, 1000);

});


</script>


<script type="text/javascript">
$(document).ready(function() {

    (function($) {
        var patterns = [];
        $('#filter').keyup(function() {
            $('.searchable tr').hide();
            console.log($(this).val());
            $(this).val().split(',').forEach(function(r) {
                var rex = new RegExp(r, "i");
                $('.searchable tr').filter(function() {
                    return rex.test($(this).text());
                }).show();
            })  
        })

    }(jQuery));


    $('#filter').keydown(function(event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            return false;
        }
    });

});
</script>



{% endblock %}
