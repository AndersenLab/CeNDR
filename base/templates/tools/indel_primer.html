{% extends "_layouts/default.html" %}

{% block custom_head %}
	<script type="text/javascript" src="//igv.org/web/release/2.6.2/dist/igv.min.js"></script>
	<link rel="stylesheet" href="//cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
	<script type="text/javascript" src="//cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js"></script>
{% endblock %}


{% block content %}
<strong>Coming Soon</strong>
{#
{% from "macros.html" import render_field %}

<div class="container-fluid">
	<div class = "row">
		<p>
			This web-based tool is designed to compare any two wild <i>C. elegans</i> strains for insertion-deletion (indel) variants that can be genotyped using PCR. These molecular markers can be used to follow each respective genetic background in crosses. Enter a specific genomic region. The following page will output indel variants that can be genotyped by PCR. For each of these indels, you can search for primers to genotype them in the two wild strains using differential PCR
			product sizes. Primers are designed to avoid natural variants in either strain to ensure that the PCR works in both genetic backgrounds.
		</p>
	</div>
	<div class='row'>
		<form id='form-submit' method="POST">
			{{ form.csrf_token }}
			<div class='col-md-2'>{{ render_field(form.strain_1) }}</div>
			<div class='col-md-2'>{{ render_field(form.strain_2) }}</div>
			<div class='col-md-2'>{{ render_field(form.chromosome) }}</div>
			<div class='col-md-2'>{{ render_field(form.start, placeholder="1,425,000") }}</div>
			<div class='col-md-2'>{{ render_field(form.stop, placeholder="1,465,000") }}</div>
			<div class='col-md-2'>
				<label>&nbsp;</label> <br />
				<button id='find_indels' type='submit' value="submit" class="btn btn-primary btn-block"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Find Indels</button>
			</div>
		</form>
	</div>
	<div class="row">
		<div id="browser"></div>
		<table id="results" class='table table-striped table-hover table-compact'></table>
	</div>
</div>
#}

{% endblock %}

{% block script %}

<script>

/*
	IGV Browser
*/
var browserDiv = $("#browser"),
                options = {
                    showNavigation: true,
                    showKaryo: false,
                    reference: {
                      id: "WS245",
                      fastaURL: "//storage.googleapis.com/elegansvariation.org/browser_tracks/c_elegans.PRJNA13758.WS245.genomic.fa",
                    },
                };

var browser
var query_running = false
var loaded = false
var table
$(document).ready(function(){
	
	let COLORS = {
		INS: 'blue',
		DEL: 'red'
	}

	set_position = function() {
		// Sets browser position based on input
		browser = igv.getBrowser()
		chromosome = $("#chromosome").val()
		start = $("#start").val()
		end = $("#stop").val()
		if (end - start > 1000000) {
			end = start + 1000000
		}
		browser.search(`${chromosome}:${start}-${end}`)
	}

	reset_query = function() {
		query_running = false
	}

	submitForm = function() {
		if (query_running == false) {
			query_running = true
			$("form").submit()
		}
		setTimeout(reset_query, 200)
	}

    $('form').submit(function (e) {
		e.preventDefault();
		var url = "{{ url_for('indel_primer.pairwise_indel_finder_query') }}"
		$.ajax({type: "POST",
				url: url,
				data: $('form').serialize(),
				success: function(data) {
                    results = data["results"]
                    _.each(results, function(x) { console.log(x);  x['generate_primers'] = `<div id="generate_primers" site="${x['CHROM']}:${x["START"]}-${x["END"]}" class='btn-link'>Generate Primers</div>` })
					// Handle errors
					$(".form-error").remove();
					if (Object.keys(data).indexOf("errors") > -1) {
						for(error in data["errors"]) {
							$("[for='" + error + "']").parent().append(`<div class='form-error'>${data["errors"][error]}</div>`)
						}
					} else {
						if (loaded == false) {
							// Create genome browser
							browser = igv.createBrowser(browserDiv, options)
							             .then(function(browser) {
											 set_position()
											 browser.on('locuschange', function(reference_frame, label) {
												 $("#chromosome").val(reference_frame["chr"]);
												 $("#start").val(reference_frame["start"]);
												 $("#stop").val(reference_frame["end"]);
												 setTimeout(submitForm, 500)
											 })
                                         })

							table = $("#results").DataTable({
								data: results,
								paging:   false,
								ordering: true,
								searching: false,
								order: [[1, "asc"]],
								columnDefs: [
									{ targets: [0], orderData: [1,2] }
								],
								columns: [
								{ data: "site", title: "Site" },
								{ data: "START", title: "Start", visible: false },
								{ data: "END", title: "End", visible: false },
                                { data: "STRAIN", title: "Strain" },
                                { data: "generate_primers", renderer: "html" }
								]
                            });

							loaded = true;
						} else {
							table.clear()
							table.rows.add(results);
							table.draw();
							// Remove all tracks
							browser.removeAllTracks()
						}
					
						// Load tracks
						rowset = {}
						rowset[$("#strain_1").val()] = []
						rowset[$("#strain_2").val()] = []
						tracks = []

						// Restructure results by strain
						for(idx in results) {
							row = results[idx]
							rowset[row["STRAIN"]].push(row)
						}
						for(strain in rowset) {
							track = rowset[strain]
							items = _.map(track, function(row) {
								result = {
									chr: row["CHROM"],
									start: row["START"],
									end: row["END"],
									name: `${row["site"]}`,
									color: COLORS[row["SVTYPE"]],
								}
								return(result)
							})
							igvTrack = {
								name: strain,
								type: "annotation",
								features: items,
							}
							browser.loadTrack(igvTrack)
						}
					}
                    query_running = false;
                    
                    // Activate primer generation links
                    $("#generate_primers").on("click", function(e) {
                        var data = {
                            site: $(this).attr("site"),
                            strain_1: $("#strain_1").val(),
                            strain_2: $("#strain_2").val()
                        }
                        $.ajax({
                                type: "POST",
                                url: "{{ url_for('indel_primer.submit_indel_primer') }}",
                                data: JSON.stringify(data),
                                contentType: "application/json; charset=utf-8",
                                dataType: 'json',
                                success:function(result){
                                    window.location = `indel_primer/result/${result.data_hash}`
                                }
                        })
                    });

				}
            });
            
        
	});

	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
				xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
			}
		}
	});

	// Initial request
    submitForm()
    
});
</script>

{% endblock %}


