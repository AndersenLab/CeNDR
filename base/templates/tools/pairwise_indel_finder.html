{% extends "_layouts/default.html" %}

{% block custom_head %}
	<link rel="stylesheet" href="//cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css" />
	<script type="text/javascript" src="//cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
{% endblock %}


{% block content %}
{% from "macros.html" import render_field %}

<div class="container-fluid">
	<div class = "row">
		<p>
			This web-based tool is designed to compare any two wild <i>C. elegans</i> strains for insertion-deletion (indel) variants that can be genotyped using PCR. These molecular markers can be used to follow each respective genetic background in crosses. Enter a specific genomic region. The following page will output indel variants that can be genotyped by PCR. For each of these indels, you can search for primers to genotype them in the two wild strains using differential PCR
			product sizes. Primers are designed to avoid natural variants in either strain to ensure that the PCR works in both genetic backgrounds.
		</p>
	</div>
	<div class='row'>
		<form id='form-submit' method="POST">
			{{ form.csrf_token }}
			<div class='col-md-2'>{{ render_field(form.strain_1) }}</div>
			<div class='col-md-2'>{{ render_field(form.strain_2) }}</div>
			<div class='col-md-2'>{{ render_field(form.chromosome) }}</div>
			<div class='col-md-2'>{{ render_field(form.start, placeholder="1,425,000", value=1) }}</div>
			<div class='col-md-2'>{{ render_field(form.stop, placeholder="1,465,000", value=1000000) }}</div>
			<div class='col-md-2'>
				<label>&nbsp;</label> <br />
				<button id='find_indels' type='submit' value="submit" class="btn btn-primary btn-block"><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Find Indels</button>
			</div>
		</form>
	</div>
	<div class="row">
		<table id="results" class='table table-striped table-hover table-compact'></table>
	</div>
</div>

{% endblock %}

{% block script %}

<script>
function onSubmitData(){
	flag = 0
	// validate
	if (($("#di").val().indexOf(',') >-1) || ($("#di").val().indexOf('.') >-1) || ($("#ti").val().indexOf(',') >-1) || ($("#ti").val().indexOf('.') >-1)) {
		$("#di").val($("#di").val().replace(',', '').replace('.',''))
		$("#ti").val($("#ti").val().replace(',', '').replace('.',''))
		flag = 1
	}
	
	console.log("validate");
	DA = { id1: $("#strain1 option:selected").text(), id2: $("#strain2 option:selected").text(), chrom: $("#chrom option:selected").text(), start:$("#di").val(), stop:$("#ti").val()}
	console.log(DA);
	console.log("== V ==");
	
	if (DA["start"] == "" || DA["stop"] == "" || DA["id1"] == DA["id2"] || DA["start"].match(/^[0-9 ]+$/) == null || DA["stop"].match(/^[0-9 ]+$/) == null) { 
		alert("Commas and dots removed from Genome pos. start and stop, as only integer digits are permitted !! \n\nPlease enter valid inputs !!");
		return false
	}
	if (flag == 1) {alert( "Commas and dots removed from Genome pos. start and stop, as only integer digits are permitted !! " )};
	return true
};

function isNumber(evt) {
    evt = (evt) ? evt : window.event;
    var charCode = (evt.which) ? evt.which : evt.keyCode;
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        return false;
    }
    return true;
};

var DA;
var loaded = false
var table
$(document).ready(function(){
    $('form').submit(function (e) {
		e.preventDefault();
		//DA = { id1: $("#strain1 option:selected").text(), id2: $("#strain2 option:selected").text(), chrom: $("#chrom option:selected").text(), start:$("#di").val(), stop:$("#ti").val()}
		var url = "{{ url_for('tools.pairwise_indel_finder_query') }}"
		$.ajax({type: "POST",
				url: url,
				data: $('form').serialize(),
				success: function(data) {
					results = data["results"]
					// Handle errors
					$(".form-error").remove();
					if (Object.keys(data).indexOf("errors") > -1) {
						for(error in data["errors"]) {
							console.log($("[for='" + error + "']"))
							$("[for='" + error + "']").parent().append(`<div class='form-error'>${data["errors"][error]}</div>`)
						}
					} else {
						if (loaded == false) {
							table = $("#results").DataTable({
								data: results,
								paging:   false,
								ordering: true,
								searching: false,
								columns: [
								{ data: "CHROM", title: "Chromosome" },
								{ data: "START", title: "Start" },
								{ data: "STRAIN", title: "Strain" },
							]
							});
							loaded = true;
							console.log(loaded)
						} else {
							table.clear()
							table.rows.add(results);
							table.draw();
						}
					}
				}
		});
	});

	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
				xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
			}
		}
	})
});
</script>

{% endblock %}


